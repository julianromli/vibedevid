# Planning Workflow Test Plan

## 1. Objective

Validate that the planning workflow (via `@plan` command) correctly processes user requests, generates appropriate prompts, and dispatches subagents to create actionable implementation plans.

## 2. Scope

- **In Scope:**
  - Plan command parsing and prompt generation
  - Subagent dispatch with correct parameters
  - Plan file creation in `.opencode/plans/`
  - Plan structure compliance (sections, tasks, dependencies)

- **Out of Scope:**
  - Plan execution (implementation phase)
  - Plan editing/modification after creation
  - Integration with external tools beyond subagent dispatch

## 3. Assumptions

- The `@plan` command is available and functional
- Subagent dispatch mechanism (`task` tool) is operational
- Plan file directory (`.opencode/plans/`) exists and is writable
- User has provided a valid request message with context

## 4. Test Cases

### 4.1 Normal Flow - Basic Request

**Test ID:** TC-001
**Description:** Verify planning workflow handles a straightforward feature request

**Steps:**
1. User sends: `@plan Create a login form component`
2. System parses command and extracts request
3. System generates prompt for plan subagent
4. Subagent is dispatched with appropriate context
5. Plan file is created with required sections

**Expected Output:**
- Plan file created at `.opencode/plans/<timestamp>-<slug>.md`
- File contains: Context, Task Dependency Graph, Parallel Execution Graph, Tasks, Commit Strategy, Success Criteria
- Each task has: Description, Delegation Recommendation, Skills Evaluation, Depends On, Acceptance Criteria

**Verification:**
```bash
# Check plan file exists
ls .opencode/plans/*.md

# Verify structure
grep -E "^## (Context|Task Dependency Graph|Parallel Execution Graph|Tasks|Commit Strategy|Success Criteria)" .opencode/plans/<file>
```

### 4.2 Normal Flow - Request with Context

**Test ID:** TC-002
**Description:** Verify planning workflow incorporates prior conversation context

**Steps:**
1. User sends: `hello`
2. User sends: `@plan test plan Use the above message and context`
3. System includes "hello" message in context
4. Subagent receives full context

**Expected Output:**
- Plan Context section references prior "hello" message
- Plan acknowledges and uses provided context appropriately

**Verification:**
```bash
grep -i "hello" .opencode/plans/<file>
```

### 4.3 Ambiguity Handling - Vague Request

**Test ID:** TC-003
**Description:** Verify planning workflow handles ambiguous/vague requests gracefully

**Steps:**
1. User sends: `@plan do something`
2. System attempts to generate plan

**Expected Output:**
- Plan is still generated (subagent makes reasonable assumptions)
- OR System asks clarifying questions before proceeding
- Plan includes assumptions section documenting interpretations

**Verification:**
- Check if plan file exists
- Review Context section for documented assumptions

### 4.4 Failure Handling - Missing Context

**Test ID:** TC-004
**Description:** Verify behavior when context is insufficient

**Steps:**
1. User sends: `@plan` (empty request)
2. System processes command

**Expected Output:**
- Error message or guidance provided
- No plan file created with empty/invalid content
- User receives feedback about missing request details

**Verification:**
- No new plan file created in `.opencode/plans/`
- User sees error/help message

### 4.5 Failure Handling - Subagent Dispatch Failure

**Test ID:** TC-005
**Description:** Verify graceful handling when subagent dispatch fails

**Steps:**
1. User sends valid plan request
2. Subagent dispatch encounters error (simulated or actual)

**Expected Output:**
- Error is caught and reported to user
- Partial plan file is not left in inconsistent state
- User receives actionable error message

**Verification:**
- Check for error messages in output
- Verify no incomplete plan files exist

## 5. Verification Steps

### 5.1 Automated Verification

Run these commands to verify plan compliance:

```bash
# 1. Check plan file exists
if [ -f .opencode/plans/*.md ]; then
    echo "✓ Plan file created"
else
    echo "✗ Plan file not found"
fi

# 2. Verify required sections
REQUIRED_SECTIONS=("Context" "Task Dependency Graph" "Parallel Execution Graph" "Tasks" "Commit Strategy" "Success Criteria")
for section in "${REQUIRED_SECTIONS[@]}"; do
    if grep -q "^## $section" .opencode/plans/*.md; then
        echo "✓ Section '$section' present"
    else
        echo "✗ Section '$section' missing"
    fi
done

# 3. Verify task structure
if grep -q "### Task" .opencode/plans/*.md; then
    echo "✓ Tasks defined"
else
    echo "✗ No tasks found"
fi

# 4. Verify delegation recommendations
if grep -q "Delegation Recommendation" .opencode/plans/*.md; then
    echo "✓ Delegation recommendations present"
else
    echo "✗ Delegation recommendations missing"
fi
```

### 5.2 Manual Verification

1. **Read the plan file:**
   ```bash
   cat .opencode/plans/<timestamp>-<slug>.md
   ```

2. **Check for clarity:**
   - Are tasks actionable and specific?
   - Are dependencies clearly mapped?
   - Are acceptance criteria verifiable?

3. **Validate format:**
   - Proper markdown formatting
   - Consistent heading levels
   - Code blocks properly fenced

## 6. Success Criteria

| Criteria | Weight | Verification Method |
|----------|--------|---------------------|
| Plan file created successfully | 20% | File exists check |
| All required sections present | 25% | grep for section headers |
| At least one task defined | 15% | grep for "### Task" |
| Dependencies documented | 15% | grep for "Depends On" |
| Acceptance criteria specified | 15% | grep for "Acceptance Criteria" |
| Format is valid markdown | 10% | Visual inspection |

**Overall Success Threshold:** 80% (4/5 weighted criteria met)

## 7. Exit Criteria

The test is complete when:
- [ ] All applicable test cases executed
- [ ] Success criteria evaluated
- [ ] Results documented
- [ ] Any failures analyzed and reported

## 8. Test Output Location

Results should be documented in:
`.opencode/plans/test-results-<timestamp>.md`

---

**Test Plan Version:** 1.0
**Created:** 2026-02-07
**Status:** Ready for Execution
